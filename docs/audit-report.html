<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local Business CMS - Comprehensive Audit Report</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --p1: #dc2626;
      --p2: #f59e0b;
      --p3: #3b82f6;
      --bg: #ffffff;
      --surface: #f9fafb;
      --border: #e5e7eb;
      --text: #111827;
      --text-muted: #6b7280;
      --code-bg: #f3f4f6;
      --success: #10b981;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      line-height: 1.6;
      color: var(--text);
      background: var(--surface);
    }

    .container {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh;
    }

    .sidebar {
      background: var(--bg);
      border-right: 1px solid var(--border);
      padding: 2rem 1rem;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }

    .sidebar h2 {
      font-size: 0.875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }

    .sidebar nav ul {
      list-style: none;
    }

    .sidebar nav li {
      margin-bottom: 0.5rem;
    }

    .sidebar nav a {
      display: block;
      color: var(--text);
      text-decoration: none;
      font-size: 0.875rem;
      padding: 0.5rem;
      border-radius: 0.375rem;
      transition: background 0.2s;
    }

    .sidebar nav a:hover {
      background: var(--surface);
    }

    .sidebar nav ul ul {
      margin-left: 1rem;
      margin-top: 0.25rem;
    }

    .sidebar nav ul ul a {
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    .main {
      padding: 3rem;
      max-width: 1200px;
    }

    h1 {
      font-size: 2.25rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    .subtitle {
      font-size: 1.125rem;
      color: var(--text-muted);
      margin-bottom: 2rem;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 2rem 0;
    }

    .card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 1.5rem;
    }

    .card-title {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .card-value {
      font-size: 2rem;
      font-weight: 700;
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .badge-p1 { background: #fee2e2; color: var(--p1); }
    .badge-p2 { background: #fef3c7; color: #d97706; }
    .badge-p3 { background: #dbeafe; color: var(--p3); }
    .badge-s { background: #d1fae5; color: #065f46; }
    .badge-m { background: #fed7aa; color: #9a3412; }
    .badge-l { background: #fecaca; color: #991b1b; }

    h2 {
      font-size: 1.875rem;
      font-weight: 700;
      margin: 3rem 0 1.5rem 0;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--border);
    }

    h3 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 2rem 0 1rem 0;
    }

    h4 {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 1.5rem 0 0.75rem 0;
    }

    p {
      margin-bottom: 1rem;
    }

    .finding {
      background: var(--bg);
      border: 1px solid var(--border);
      border-left: 4px solid var(--p2);
      border-radius: 0.5rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .finding.p1 { border-left-color: var(--p1); }
    .finding.p2 { border-left-color: var(--p2); }
    .finding.p3 { border-left-color: var(--p3); }

    .finding-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
    }

    .finding-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .finding-file {
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.875rem;
      color: var(--text-muted);
      background: var(--code-bg);
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      display: inline-block;
      margin: 0.5rem 0;
    }

    .finding-badges {
      display: flex;
      gap: 0.5rem;
      flex-shrink: 0;
      margin-left: 1rem;
    }

    .finding-content p {
      margin-bottom: 0.75rem;
    }

    .finding-impact {
      background: var(--surface);
      border-left: 3px solid var(--p2);
      padding: 0.75rem 1rem;
      margin: 1rem 0;
      font-size: 0.9375rem;
    }

    .finding-impact strong {
      display: block;
      margin-bottom: 0.25rem;
      color: var(--text-muted);
      font-size: 0.8125rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .code-block {
      position: relative;
      margin: 1rem 0;
    }

    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #1e293b;
      color: #e2e8f0;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem 0.5rem 0 0;
      font-size: 0.875rem;
    }

    .copy-btn {
      background: #334155;
      color: #e2e8f0;
      border: none;
      padding: 0.25rem 0.75rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .copy-btn:hover {
      background: #475569;
    }

    .copy-btn.copied {
      background: var(--success);
    }

    pre {
      background: #0f172a;
      color: #e2e8f0;
      padding: 1rem;
      border-radius: 0 0 0.5rem 0.5rem;
      overflow-x: auto;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.875rem;
      line-height: 1.5;
      margin: 0;
    }

    .collapsible {
      margin: 1rem 0;
    }

    .collapsible-toggle {
      background: var(--surface);
      border: 1px solid var(--border);
      width: 100%;
      text-align: left;
      padding: 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }

    .collapsible-toggle:hover {
      background: #f3f4f6;
    }

    .collapsible-toggle::after {
      content: '▼';
      transition: transform 0.2s;
      font-size: 0.75rem;
    }

    .collapsible-toggle.active::after {
      transform: rotate(-180deg);
    }

    .collapsible-content {
      display: none;
      padding: 1rem;
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 0.5rem 0.5rem;
      background: var(--bg);
    }

    .collapsible-content.active {
      display: block;
    }

    ul, ol {
      margin-left: 1.5rem;
      margin-bottom: 1rem;
    }

    li {
      margin-bottom: 0.5rem;
    }

    .table-wrapper {
      overflow-x: auto;
      margin: 1.5rem 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
    }

    th {
      background: var(--surface);
      padding: 0.75rem 1rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.875rem;
      border-bottom: 2px solid var(--border);
    }

    td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.875rem;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .pr-plan {
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 0.5rem;
      padding: 2rem;
      margin: 2rem 0;
    }

    .pr-plan h4 {
      margin-top: 0;
    }

    .checklist {
      list-style: none;
      margin-left: 0;
    }

    .checklist li {
      padding-left: 1.75rem;
      position: relative;
    }

    .checklist li::before {
      content: '☐';
      position: absolute;
      left: 0;
      font-size: 1.25rem;
      line-height: 1.6;
    }

    .alert {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 0.25rem;
    }

    .alert-danger {
      background: #fee2e2;
      border-left-color: var(--p1);
    }

    code {
      background: var(--code-bg);
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.875em;
    }

    @media print {
      .sidebar { display: none; }
      .container { grid-template-columns: 1fr; }
      .copy-btn { display: none; }
    }

    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
      .sidebar {
        position: static;
        height: auto;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      .main {
        padding: 1.5rem;
      }
      .finding-header {
        flex-direction: column;
      }
      .finding-badges {
        margin-left: 0;
        margin-top: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <h2>Navigation</h2>
      <nav>
        <ul>
          <li><a href="#summary">Executive Summary</a></li>
          <li><a href="#sanity">Sanity CMS Findings</a>
            <ul>
              <li><a href="#sanity-schema">Schema</a></li>
              <li><a href="#sanity-groq">GROQ Queries</a></li>
              <li><a href="#sanity-studio">Studio Config</a></li>
              <li><a href="#sanity-webhooks">Webhooks</a></li>
              <li><a href="#sanity-seo">SEO</a></li>
              <li><a href="#sanity-multitenant">Multi-Tenant</a></li>
            </ul>
          </li>
          <li><a href="#frontend">Frontend Findings</a>
            <ul>
              <li><a href="#frontend-nextjs">Next.js</a></li>
              <li><a href="#frontend-data">Data Fetching</a></li>
              <li><a href="#frontend-a11y">Accessibility</a></li>
              <li><a href="#frontend-perf">Performance</a></li>
              <li><a href="#frontend-security">Security</a></li>
              <li><a href="#frontend-testing">Testing</a></li>
              <li><a href="#frontend-components">Components</a></li>
            </ul>
          </li>
          <li><a href="#quick-wins">Quick Wins</a></li>
          <li><a href="#findings-table">All Findings Table</a></li>
          <li><a href="#pr-plan">PR Plan</a></li>
          <li><a href="#next-steps">Next Steps</a></li>
        </ul>
      </nav>
    </aside>

    <main class="main">
      <h1 id="summary">Local Business CMS Audit Report</h1>
      <p class="subtitle">Comprehensive code audit of multi-tenant Next.js 15 + Sanity CMS platform serving 100+ business websites</p>

      <div class="alert alert-danger">
        <strong>⚠️ CRITICAL</strong>: 16 P1 issues found that require immediate attention before next deployment. Focus on cache collision, CSP headers, and slug validation.
      </div>

      <div class="summary-cards">
        <div class="card">
          <div class="card-title">Total Findings</div>
          <div class="card-value">63</div>
        </div>
        <div class="card">
          <div class="card-title">P1 Critical</div>
          <div class="card-value" style="color: var(--p1);">16</div>
        </div>
        <div class="card">
          <div class="card-title">P2 High</div>
          <div class="card-value" style="color: var(--p2);">29</div>
        </div>
        <div class="card">
          <div class="card-title">P3 Medium</div>
          <div class="card-value" style="color: var(--p3);">18</div>
        </div>
        <div class="card">
          <div class="card-title">Quick Wins</div>
          <div class="card-value" style="color: var(--success);">13</div>
        </div>
        <div class="card">
          <div class="card-title">Est. Effort (P1)</div>
          <div class="card-value" style="font-size: 1.25rem;">2-3 days</div>
        </div>
      </div>

      <h2 id="sanity">🗄️ Sanity CMS Findings</h2>
      <p><strong>Audit Scope</strong>: Schema architecture, GROQ queries, Studio configuration, webhooks, SEO implementation, multi-tenant isolation</p>
      <p><strong>Summary</strong>: 28 findings identified. Critical issues in slug validation, schema versioning, and query optimization. Strong multi-tenant isolation but needs enhancement.</p>

      <h3 id="sanity-schema">Schema Architecture (12 findings)</h3>

      <div class="finding p1">
        <div class="finding-header">
          <div>
            <div class="finding-title">Missing Slug Uniqueness Validation</div>
            <div class="finding-file">src/sanity/schemaTypes/documents/service.ts:26</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p1">P1</span>
            <span class="badge badge-s">Small</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: No slug uniqueness validation across service, location, page, offer, and post document types.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Multiple documents can have identical slugs, causing routing conflicts, 404 errors, and SEO canonicalization issues across all 100+ sites.
          </div>
          <p><strong>Affected Files</strong>:</p>
          <ul>
            <li><code>src/sanity/schemaTypes/documents/service.ts:26</code></li>
            <li><code>src/sanity/schemaTypes/documents/location.ts:22</code></li>
            <li><code>src/sanity/schemaTypes/page.ts:22</code></li>
            <li><code>src/sanity/schemaTypes/documents/offer.ts:11</code></li>
            <li><code>src/sanity/schemaTypes/post.ts:14</code></li>
          </ul>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span>Fix: Add async slug validation</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre>defineField({
  name: 'slug',
  type: 'slug',
  options: {
    source: 'title',
    slugify: (v) => v.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, ''),
  },
  validation: (r) => r.required().custom(async (slug, context) => {
    if (!slug?.current) return true;
    const {document, getClient} = context;
    const client = getClient({apiVersion: '2024-01-01'});
    const id = document._id.replace(/^drafts\\./, '');
    const params = {draft: `drafts.${id}`, published: id, slug: slug.current};
    const query = `!defined(*[_type == 'service' && slug.current == $slug && !(_id in [$draft, $published])][0]._id)`;
    const isUnique = await client.fetch(query, params);
    return isUnique || 'Slug must be unique';
  }),
})</pre>
        </div>
      </div>

      <div class="finding p1">
        <div class="finding-header">
          <div>
            <div class="finding-title">Missing Schema Versioning System</div>
            <div class="finding-file">src/sanity/schemaTypes/index.ts</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p1">P1</span>
            <span class="badge badge-m">Medium</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: No <code>_schemaVersion</code> field on any document types.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Cannot track schema evolution or run safe migrations. Breaking schema changes will cause production issues across all datasets with no rollback mechanism.
          </div>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span>Fix: Add schema version field to all documents</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre>// Add to all document schemas:
defineField({
  name: '_schemaVersion',
  type: 'number',
  title: 'Schema Version',
  initialValue: 1,
  readOnly: true,
  hidden: true,
  description: 'Internal: tracks schema version for migrations'
})</pre>
        </div>
      </div>

      <div class="finding p1">
        <div class="finding-header">
          <div>
            <div class="finding-title">Inconsistent SEO Schema</div>
            <div class="finding-file">src/sanity/schemaTypes/objects/seo.ts vs fields/seo.ts</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p1">P1</span>
            <span class="badge badge-m">Medium</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: Two different SEO schemas exist - <code>objects/seo.ts</code> (4 fields) vs <code>fields/seo.ts</code> (15+ fields with structured data).</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Inconsistent SEO capabilities across document types. Services/locations use minimal seo.ts while pages use rich fields/seo.ts. Causes confusion and technical debt.
          </div>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span>Fix: Consolidate to single SEO schema</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre>// 1. Rename objects/seo.ts to objects/seoLegacy.ts
// 2. Update all document imports:
import { seoFields } from './fields/seo'

// 3. In service.ts, location.ts, offer.ts:
defineField({
  name: 'seo',
  type: 'object',
  fields: seoFields,
  options: { collapsible: true, collapsed: true }
})

// 4. Remove objects/seo.ts from schema index after migration
// 5. Run data migration to populate new fields from old ones</pre>
        </div>
      </div>

      <div class="collapsible">
        <button class="collapsible-toggle" onclick="toggleCollapsible(this)">
          Show 9 more schema findings (P2-P3)
        </button>
        <div class="collapsible-content">
          <div class="finding p2">
            <div class="finding-header">
              <div>
                <div class="finding-title">Missing Alt Text Validation on Images</div>
                <div class="finding-file">src/sanity/schemaTypes/documents/service.ts:29-32</div>
              </div>
              <div class="finding-badges">
                <span class="badge badge-p2">P2</span>
                <span class="badge badge-s">Small</span>
              </div>
            </div>
            <div class="finding-content">
              <p><strong>Problem</strong>: Hero images and other image fields don't require alt text.</p>
              <div class="finding-impact">
                <strong>Impact</strong>
                Accessibility violations (WCAG AA failure) and poor SEO as images can be published without alt text.
              </div>
            </div>
            <div class="code-block">
              <div class="code-header">
                <span>Fix</span>
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
              </div>
              <pre>defineField({
  name: 'heroImage',
  type: 'image',
  options: { hotspot: true },
  description: '16:9 recommended',
  fields: [
    defineField({
      name: 'alt',
      type: 'string',
      title: 'Alt Text',
      validation: (r) => r.required().error('Alt text is required for accessibility'),
    })
  ],
})</pre>
            </div>
          </div>

          <div class="finding p2">
            <div class="finding-header">
              <div>
                <div class="finding-title">Missing OG Image Dimension Validation</div>
                <div class="finding-file">src/sanity/schemaTypes/fields/seo.ts:78-83</div>
              </div>
              <div class="finding-badges">
                <span class="badge badge-p2">P2</span>
                <span class="badge badge-s">Small</span>
              </div>
            </div>
            <div class="finding-content">
              <p><strong>Problem</strong>: OG/Twitter image fields lack dimension validation (should be 1200×630).</p>
              <div class="finding-impact">
                <strong>Impact</strong>
                Authors can upload wrong size images, causing poor social media previews and reduced click-through rates.
              </div>
            </div>
          </div>

          <div class="finding p3">
            <div class="finding-header">
              <div>
                <div class="finding-title">Singleton Missing liveEdit Configuration</div>
                <div class="finding-file">src/sanity/schemaTypes/singletons/*.ts</div>
              </div>
              <div class="finding-badges">
                <span class="badge badge-p3">P3</span>
                <span class="badge badge-s">Small</span>
              </div>
            </div>
            <div class="finding-content">
              <p><strong>Problem</strong>: Singleton documents (siteSettings, siteConfig, robotsTxt) missing <code>__experimental_liveEdit: true</code>.</p>
              <div class="finding-impact">
                <strong>Impact</strong>
                Authors must click Publish to see changes in frequently-edited global settings, causing poor UX.
              </div>
            </div>
            <div class="code-block">
              <div class="code-header">
                <span>Fix</span>
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
              </div>
              <pre>export default defineType({
  name: 'siteSettings',
  title: 'Global Settings',
  type: 'document',
  icon: CogIcon,
  __experimental_liveEdit: true, // Add this line
  groups: [...]
})</pre>
            </div>
          </div>

          <p style="margin-top: 1rem;"><em>Additional P3 schema findings: testimonial rating validation (integer), serviceCategory description, sitemap priority fields - see full details in agent reports</em></p>
        </div>
      </div>

      <h3 id="sanity-groq">GROQ Queries (8 findings)</h3>

      <div class="finding p1">
        <div class="finding-header">
          <div>
            <div class="finding-title">Missing Pagination on List Queries</div>
            <div class="finding-file">src/sanity/queries.ts:139-151, 435-439</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p1">P1</span>
            <span class="badge badge-s">Small</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: <code>servicesQ</code> and <code>locationsListQ</code> return all documents with no limit.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            At 500+ services or 200+ locations, queries will timeout or cause memory issues. Frontend will be slow across all sites.
          </div>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span>Fix: Add pagination limits</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre>// Add limits to prevent runaway queries
export const servicesQ = groq`*[_type == "service" && defined(slug.current)]|order(title asc)[0...100]{...}`

// Add paginated version:
export const servicesPaginatedQ = groq`*[_type == "service" && defined(slug.current)]|order(title asc)[$start...$end]{...}`

export const locationsListQ = groq`*[_type == "location" && defined(slug.current)]|order(city asc)[0...100]{...}`</pre>
        </div>
      </div>

      <div class="finding p2">
        <div class="finding-header">
          <div>
            <div class="finding-title">Missing NULL Guards on Reference Arrays</div>
            <div class="finding-file">src/sanity/queries.ts:220-223, 415-430</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p2">P2</span>
            <span class="badge badge-s">Small</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: Reference resolutions lack <code>defined()</code> checks on dereferenced arrays.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Deleted locations/services referenced by other documents will return null entries in arrays, causing frontend crashes.
          </div>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span>Fix: Add defined() filter</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre>// Before:
locations[]->{city, "slug":slug.current}

// After:
locations[]->{city, "slug":slug.current} | defined(@)</pre>
        </div>
      </div>

      <div class="finding p2">
        <div class="finding-header">
          <div>
            <div class="finding-title">Over-fetching in Section Queries</div>
            <div class="finding-file">src/sanity/queries.ts:228-373</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p2">P2</span>
            <span class="badge badge-m">Medium</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: <code>serviceBySlugQ</code> sections array fetches entire section payloads including nested references.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Query can take 2-5 seconds for pages with 10+ sections. N+1 query pattern on references.
          </div>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span>Fix: Optimize section projection</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre>sections[]{
  _type,
  _key,
  // Only fetch fields needed for rendering
  select(
    _type == 'section.testimonials' => {
      heading,
      subheading,
      "testimonials": testimonials[]->{ _id, author, quote, rating }
    },
    _type == 'section.services' => {
      heading,
      "services": services[0...6]->{ _id, title, "slug": slug.current, heroImage{asset->url} }
    },
    {...} // Default
  )
}</pre>
        </div>
      </div>

      <div class="collapsible">
        <button class="collapsible-toggle" onclick="toggleCollapsible(this)">
          Show 5 more GROQ findings
        </button>
        <div class="collapsible-content">
          <p><em>Additional findings: Missing _updatedAt fields, draft document leakage risks, sitemap missing priority data - see agent reports for details</em></p>
        </div>
      </div>

      <h3 id="sanity-studio">Studio Configuration (3 findings)</h3>

      <div class="finding p2">
        <div class="finding-header">
          <div>
            <div class="finding-title">No Role-Based Desk Structure</div>
            <div class="finding-file">src/sanity/structure.ts</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p2">P2</span>
            <span class="badge badge-m">Medium</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: Desk structure shows all document types to all users without role filtering.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Authors see admin-only docs (redirects, webhooks, audit logs), causing confusion and potential security exposure.
          </div>
        </div>
      </div>

      <div class="collapsible">
        <button class="collapsible-toggle" onclick="toggleCollapsible(this)">
          Show 2 more Studio findings
        </button>
        <div class="collapsible-content">
          <p><em>Missing document actions (duplicate, unpublish), search configuration not weighted for local business use case</em></p>
        </div>
      </div>

      <h3 id="sanity-webhooks">Webhooks & Revalidation (3 findings)</h3>

      <div class="finding p2">
        <div class="finding-header">
          <div>
            <div class="finding-title">Incorrect Exponential Backoff</div>
            <div class="finding-file">src/sanity/lib/webhook-manager.ts:373-375</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p2">P2</span>
            <span class="badge badge-s">Small</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: Backoff multiplies by attemptNumber instead of using exponential calculation.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Retries happen too quickly (5s, 10s, 15s instead of 5s, 10s, 20s, 40s), overwhelming failing endpoints.
          </div>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span>Fix: Use proper exponential backoff</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre>// Line 374:
const delay = retryDelay * Math.pow(2, attemptNumber - 1) * 1000
// This gives: 5s, 10s, 20s, 40s... (correct exponential)</pre>
        </div>
      </div>

      <div class="finding p2">
        <div class="finding-header">
          <div>
            <div class="finding-title">Missing Rate Limiting on Webhooks</div>
            <div class="finding-file">src/sanity/lib/webhook-manager.ts:311-386</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p2">P2</span>
            <span class="badge badge-m">Medium</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: No rate limiting on webhook deliveries.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Bulk operations (re-publish 100 services) will fire 100 webhooks instantly, crashing receiving endpoints.
          </div>
        </div>
      </div>

      <h3 id="sanity-seo">SEO & Metadata (3 findings)</h3>

      <div class="finding p2">
        <div class="finding-header">
          <div>
            <div class="finding-title">Missing Specific Business Type in JSON-LD</div>
            <div class="finding-file">src/lib/jsonld.ts:36-43</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p2">P2</span>
            <span class="badge badge-s">Small</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: Always outputs <code>@type: 'LocalBusiness'</code> instead of specific types (Plumber, Electrician, etc.).</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Missing rich results for specific business types which have dedicated schema.org types and better SERP features.
          </div>
        </div>
      </div>

      <h3 id="sanity-multitenant">Multi-Tenant Concerns (2 findings)</h3>

      <div class="finding p1">
        <div class="finding-header">
          <div>
            <div class="finding-title">Dataset Validation Function Missing</div>
            <div class="finding-file">src/sanity/schemaTypes/singletons/siteConfig.ts:83-85</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p1">P1</span>
            <span class="badge badge-s">Small</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: <code>datasetName</code> field is readOnly but not validated against actual <code>NEXT_PUBLIC_SANITY_DATASET</code>.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Mismatch between siteConfig.datasetName and actual dataset can cause silent data corruption in multi-tenant setup.
          </div>
        </div>
      </div>

      <h2 id="frontend">⚛️ Frontend Findings</h2>
      <p><strong>Audit Scope</strong>: Next.js architecture, data fetching, accessibility, performance, security, testing, component quality</p>
      <p><strong>Summary</strong>: 35 findings identified. Critical security issues (CSP, cache collision, XSS), performance optimizations, and accessibility gaps.</p>

      <h3 id="frontend-nextjs">Next.js Architecture (5 findings)</h3>

      <div class="finding p1">
        <div class="finding-header">
          <div>
            <div class="finding-title">Missing Viewport Metadata</div>
            <div class="finding-file">src/app/layout.tsx:31</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p1">P1</span>
            <span class="badge badge-s">Small</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: No viewport configuration in root layout metadata.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Poor mobile UX, potential SEO penalties, incorrect scaling on mobile devices, Core Web Vitals degradation.
          </div>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span>Fix: Add viewport metadata</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre>export const metadata: Metadata = {
  title: {
    default: 'Local Business',
    template: '%s | Local Business',
  },
  description: 'A CMS-driven marketing site for local service businesses.',
  viewport: {
    width: 'device-width',
    initialScale: 1,
    maximumScale: 5,
  },
}</pre>
        </div>
      </div>

      <div class="finding p2">
        <div class="finding-header">
          <div>
            <div class="finding-title">Unnecessary Client Components</div>
            <div class="finding-file">src/components/Portable.tsx:1</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p2">P2</span>
            <span class="badge badge-m">Medium</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: Portable.tsx uses 'use client' but doesn't need client-side interactivity.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Larger JavaScript bundles sent to client, slower page loads, wasted computational resources multiplied across 100+ sites.
          </div>
        </div>
      </div>

      <div class="collapsible">
        <button class="collapsible-toggle" onclick="toggleCollapsible(this)">
          Show 3 more Next.js findings
        </button>
        <div class="collapsible-content">
          <p><em>Missing route-specific error boundaries, aggressive ISR causing cache stampede, unnecessary draftMode checks on every request</em></p>
        </div>
      </div>

      <h3 id="frontend-data">Data Fetching & Adapters (3 findings)</h3>

      <div class="finding p1">
        <div class="finding-header">
          <div>
            <div class="finding-title">Cache Collision Risk in Multi-Tenant Setup</div>
            <div class="finding-file">src/sanity/loaders.ts:48</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p1">P1</span>
            <span class="badge badge-m">Medium</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: All datasets use same cache tag prefix. If multiple sites run on same infrastructure, cache could collide.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            🚨 CRITICAL: Site A's data could be served to Site B users, causing data leaks and privacy violations across tenant boundaries.
          </div>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span>Fix: Make cache tags dataset-specific</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre>const fetchOptions = {
  perspective: 'published' as const,
  next: {
    revalidate: 120,
    // Make cache tag dataset-specific to prevent cross-site pollution
    tags: [
      getSiteCachePrefix(),
      `dataset-${process.env.NEXT_PUBLIC_SANITY_DATASET}`,
      `project-${process.env.NEXT_PUBLIC_SANITY_PROJECT_ID}`,
    ],
  },
}</pre>
        </div>
      </div>

      <div class="finding p1">
        <div class="finding-header">
          <div>
            <div class="finding-title">No Error Boundaries Around SectionRenderer</div>
            <div class="finding-file">src/components/sections/SectionRenderer.tsx</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p1">P1</span>
            <span class="badge badge-m">Medium</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: SectionRenderer directly maps over sections without error handling.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Single malformed CMS section crashes entire page for all users. No graceful degradation.
          </div>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span>Fix: Add error boundary per section</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre>{sections.map((section) => (
  <ErrorBoundary key={section._key} fallback={null}>
    <SectionItem section={section} {...props} />
  </ErrorBoundary>
))}</pre>
        </div>
      </div>

      <h3 id="frontend-a11y">Accessibility (5 findings)</h3>

      <div class="finding p1">
        <div class="finding-header">
          <div>
            <div class="finding-title">Portable Images Not Using Next/Image</div>
            <div class="finding-file">src/components/Portable.tsx:8-15</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p1">P1</span>
            <span class="badge badge-m">Medium</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: Uses native <code>&lt;img&gt;</code> tag instead of Next.js <code>&lt;Image&gt;</code> component.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Slow image loads, poor LCP, no automatic WebP/AVIF conversion, CLS issues, accessibility problems with missing dimensions.
          </div>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span>Fix: Use Next.js Image component</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre>import Image from 'next/image'

const components: PortableTextComponents = {
  types: {
    image: ({ value }) => {
      const imageUrl = getImageUrl(value)
      const imageAlt = getImageAlt(value)
      const width = value?.asset?.metadata?.dimensions?.width ?? 800
      const height = value?.asset?.metadata?.dimensions?.height ?? 600

      return imageUrl ? (
        <Image
          src={imageUrl}
          alt={imageAlt}
          width={width}
          height={height}
          sizes="(min-width: 768px) 700px, 100vw"
          className="rounded-lg"
        />
      ) : null
    },
  },
}</pre>
        </div>
      </div>

      <div class="finding p2">
        <div class="finding-header">
          <div>
            <div class="finding-title">Missing ARIA Live Regions for Form Feedback</div>
            <div class="finding-file">src/components/forms/LeadCaptureForm.tsx:99-104</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p2">P2</span>
            <span class="badge badge-s">Small</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: Success/error messages appear without announcing to screen readers.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Screen reader users don't know form was submitted or if there's an error. WCAG 2.1 Level AA violation (4.1.3).
          </div>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span>Fix: Add aria-live regions</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre>{state.status === 'success' ? (
  <p
    role="status"
    aria-live="polite"
    className="rounded-xl bg-emerald-50 px-3 py-2 text-sm text-emerald-700"
  >
    {state.message}
  </p>
) : null}
{state.status === 'error' || state.status === 'disabled' ? (
  <p
    role="alert"
    aria-live="assertive"
    className="rounded-xl bg-red-50 px-3 py-2 text-sm text-red-700"
  >
    {state.message}
  </p>
) : null}</pre>
        </div>
      </div>

      <div class="collapsible">
        <button class="collapsible-toggle" onclick="toggleCollapsible(this)">
          Show 3 more accessibility findings
        </button>
        <div class="collapsible-content">
          <p><em>Honeypot field accessibility, mega menu aria-expanded states, link color contrast validation</em></p>
        </div>
      </div>

      <h3 id="frontend-perf">Performance (5 findings)</h3>

      <div class="finding p1">
        <div class="finding-header">
          <div>
            <div class="finding-title">Hero Images Missing Priority Hint</div>
            <div class="finding-file">src/components/sections/HeroSection.tsx:40, 99</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p1">P1</span>
            <span class="badge badge-s">Small</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: Hero images use <code>loadingPriority</code> from CMS but don't default to 'eager' for first hero.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Slow LCP (Largest Contentful Paint), poor Core Web Vitals across all 100+ sites, especially homepage (highest traffic).
          </div>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span>Fix: Default first hero to eager priority</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre>export default function HeroSection({
  section,
  isFirstSection = false // Add this prop
}: HeroSectionProps & { isFirstSection?: boolean }) {

  // Update priority logic
  priority={
    ((section.media as { loadingPriority?: string })?.loadingPriority as 'eager' | 'lazy' | 'auto')
    || (isFirstSection ? 'eager' : 'auto') // Default first hero to eager
  }
}</pre>
        </div>
      </div>

      <div class="finding p2">
        <div class="finding-header">
          <div>
            <div class="finding-title">Third-Party Scripts Block Rendering</div>
            <div class="finding-file">src/components/AnalyticsScripts.tsx:32-83</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p2">P2</span>
            <span class="badge badge-m">Medium</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: All analytics use <code>strategy="afterInteractive"</code> which blocks hydration.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Slower TTI (Time to Interactive), blocked main thread, poor INP (Interaction to Next Paint) scores.
          </div>
        </div>
      </div>

      <div class="collapsible">
        <button class="collapsible-toggle" onclick="toggleCollapsible(this)">
          Show 3 more performance findings
        </button>
        <div class="collapsible-content">
          <p><em>No font preloading strategy, large bundle size (409MB .next), no bundle size budgets enforced</em></p>
        </div>
      </div>

      <h3 id="frontend-security">Security (5 findings)</h3>

      <div class="finding p1">
        <div class="finding-header">
          <div>
            <div class="finding-title">No Content Security Policy Headers</div>
            <div class="finding-file">next.config.ts</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p1">P1</span>
            <span class="badge badge-m">Medium</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: No CSP headers configured anywhere.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            🚨 CRITICAL: App is vulnerable to XSS attacks, script injection, data theft across all 100+ sites. Major security vulnerability.
          </div>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span>Fix: Add CSP headers in next.config.ts</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre>const nextConfig: NextConfig = {
  // ... existing config

  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'Content-Security-Policy',
            value: [
              "default-src 'self'",
              "script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com",
              "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com",
              "img-src 'self' data: https: blob:",
              "font-src 'self' data: https://fonts.gstatic.com",
              "connect-src 'self' https://*.sanity.io https://www.google-analytics.com",
              "frame-src https://calendly.com",
            ].join('; '),
          },
          {
            key: 'X-Frame-Options',
            value: 'SAMEORIGIN',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
        ],
      },
    ]
  },
}</pre>
        </div>
      </div>

      <div class="finding p1">
        <div class="finding-header">
          <div>
            <div class="finding-title">Unsanitized Tracking Scripts from CMS</div>
            <div class="finding-file">src/components/AnalyticsScripts.tsx:86-104</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p1">P1</span>
            <span class="badge badge-m">Medium</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: Custom tracking scripts from CMS injected via <code>dangerouslySetInnerHTML</code> without validation.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            🚨 XSS vulnerability: Malicious scripts could be injected by CMS users with script access, compromising all site visitors.
          </div>
        </div>
      </div>

      <div class="finding p2">
        <div class="finding-header">
          <div>
            <div class="finding-title">Cookie-Based Rate Limiting Easily Bypassed</div>
            <div class="finding-file">src/app/actions/createLead.ts:7-8, 41-51</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p2">P2</span>
            <span class="badge badge-m">Medium</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: Rate limit uses client-controlled cookie.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Attacker can delete cookie and spam forms across all 100+ sites, causing database pollution and potential DoS.
          </div>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span>Fix: Use IP-based rate limiting with Redis</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre>import { Ratelimit } from '@upstash/ratelimit'
import { Redis } from '@upstash/redis'
import { headers } from 'next/headers'

const redis = new Redis({
  url: process.env.UPSTASH_REDIS_URL!,
  token: process.env.UPSTASH_REDIS_TOKEN!,
})

const ratelimit = new Ratelimit({
  redis,
  limiter: Ratelimit.slidingWindow(3, '60 s'),
  analytics: true,
})

export async function submitLead(_: LeadFormState, formData: FormData): Promise<LeadFormState> {
  const headersList = await headers()
  const ip = headersList.get('x-forwarded-for') || 'unknown'

  const { success } = await ratelimit.limit(ip)
  if (!success) {
    return {
      status: 'error',
      message: 'Too many requests. Please wait.',
    }
  }

  // ... rest of validation
}</pre>
        </div>
      </div>

      <div class="collapsible">
        <button class="collapsible-toggle" onclick="toggleCollapsible(this)">
          Show 2 more security findings
        </button>
        <div class="collapsible-content">
          <p><em>API tokens potentially exposed in client bundles, embedded HTML sanitization bypasses</em></p>
        </div>
      </div>

      <h3 id="frontend-testing">Testing & CI (4 findings)</h3>

      <div class="finding p1">
        <div class="finding-header">
          <div>
            <div class="finding-title">No Accessibility Tests in Playwright Suite</div>
            <div class="finding-file">tests/ directory</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p1">P1</span>
            <span class="badge badge-m">Medium</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: No axe-core integration despite Playwright being configured.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Accessibility issues slip into production across all sites, affecting users with disabilities, legal compliance risk (ADA/WCAG).
          </div>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span>Fix: Create accessibility test suite</span>
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          </div>
          <pre>// Create tests/accessibility/basic-a11y.spec.ts
import { test, expect } from '@playwright/test'
import AxeBuilder from '@axe-core/playwright'

test.describe('Accessibility Tests', () => {
  test('Homepage should not have violations', async ({ page }) => {
    await page.goto('/')

    const results = await new AxeBuilder({ page })
      .withTags(['wcag2a', 'wcag2aa', 'wcag21a', 'wcag21aa'])
      .analyze()

    expect(results.violations).toEqual([])
  })
})

// Install: pnpm add -D @axe-core/playwright</pre>
        </div>
      </div>

      <div class="finding p2">
        <div class="finding-header">
          <div>
            <div class="finding-title">Lighthouse CI Not Configured</div>
            <div class="finding-file">Missing lighthouserc.js</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p2">P2</span>
            <span class="badge badge-m">Medium</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: @lhci/cli installed but not configured or run in CI.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Performance regressions go undetected, Core Web Vitals not monitored, budget violations not caught.
          </div>
        </div>
      </div>

      <div class="collapsible">
        <button class="collapsible-toggle" onclick="toggleCollapsible(this)">
          Show 2 more testing findings
        </button>
        <div class="collapsible-content">
          <p><em>No visual regression testing, type checking not enforced in pre-commit hooks</em></p>
        </div>
      </div>

      <h3 id="frontend-components">Component Quality (3 findings)</h3>

      <div class="finding p2">
        <div class="finding-header">
          <div>
            <div class="finding-title">Missing Prop Validation in SectionRenderer</div>
            <div class="finding-file">src/components/sections/SectionRenderer.tsx:35</div>
          </div>
          <div class="finding-badges">
            <span class="badge badge-p2">P2</span>
            <span class="badge badge-m">Medium</span>
          </div>
        </div>
        <div class="finding-content">
          <p><strong>Problem</strong>: No runtime validation of section props from CMS.</p>
          <div class="finding-impact">
            <strong>Impact</strong>
            Malformed CMS data causes runtime errors and crashes. Poor developer experience debugging CMS issues.
          </div>
        </div>
      </div>

      <div class="collapsible">
        <button class="collapsible-toggle" onclick="toggleCollapsible(this)">
          Show 2 more component findings
        </button>
        <div class="collapsible-content">
          <p><em>Duplicated link resolution logic, console.warn in production builds</em></p>
        </div>
      </div>

      <h2 id="quick-wins">⚡ Quick Wins (< 30 min each, high impact)</h2>

      <div class="card" style="margin-bottom: 1rem;">
        <div class="card-title">Total Quick Win Time</div>
        <div class="card-value" style="font-size: 1.5rem; color: var(--success);">~115 minutes</div>
        <p style="margin-top: 0.5rem; color: var(--text-muted); font-size: 0.875rem;">
          Fixes 4 P1 issues, 3 P2 issues. Addresses LCP, WCAG compliance, mobile UX, query timeouts.
        </p>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Priority</th>
              <th>Fix</th>
              <th>File</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><span class="badge badge-p1">P1</span></td>
              <td>Add viewport metadata to root layout</td>
              <td><code>src/app/layout.tsx:31</code></td>
              <td>5 min</td>
            </tr>
            <tr>
              <td><span class="badge badge-p1">P1</span></td>
              <td>Add priority hint to homepage hero image</td>
              <td><code>src/components/sections/HeroSection.tsx</code></td>
              <td>15 min</td>
            </tr>
            <tr>
              <td><span class="badge badge-p1">P1</span></td>
              <td>Add pagination limits to servicesQ and locationsListQ</td>
              <td><code>src/sanity/queries.ts</code></td>
              <td>3 min</td>
            </tr>
            <tr>
              <td><span class="badge badge-p2">P2</span></td>
              <td>Add defined() filters to reference arrays in GROQ</td>
              <td><code>src/sanity/queries.ts</code></td>
              <td>10 min</td>
            </tr>
            <tr>
              <td><span class="badge badge-p2">P2</span></td>
              <td>Add aria-live regions to form feedback</td>
              <td><code>src/components/forms/LeadCaptureForm.tsx</code></td>
              <td>10 min</td>
            </tr>
            <tr>
              <td><span class="badge badge-p2">P2</span></td>
              <td>Fix exponential backoff in webhook retries</td>
              <td><code>src/sanity/lib/webhook-manager.ts:374</code></td>
              <td>2 min</td>
            </tr>
            <tr>
              <td><span class="badge badge-p3">P3</span></td>
              <td>Add font display: swap to font loading</td>
              <td><code>src/app/layout.tsx</code></td>
              <td>5 min</td>
            </tr>
            <tr>
              <td><span class="badge badge-p3">P3</span></td>
              <td>Fix honeypot field accessibility (aria-hidden)</td>
              <td><code>src/components/forms/LeadCaptureForm.tsx</code></td>
              <td>10 min</td>
            </tr>
            <tr>
              <td><span class="badge badge-p3">P3</span></td>
              <td>Add aria-expanded to mobile menu buttons</td>
              <td><code>src/components/layout/MegaMenu.tsx</code></td>
              <td>15 min</td>
            </tr>
            <tr>
              <td><span class="badge badge-p3">P3</span></td>
              <td>Remove fetchCache: 'force-cache' from pages</td>
              <td><code>src/app/*/page.tsx</code></td>
              <td>5 min</td>
            </tr>
            <tr>
              <td><span class="badge badge-p3">P3</span></td>
              <td>Remove console.warn in production builds</td>
              <td><code>src/components/ui/OptimizedImage.tsx</code></td>
              <td>5 min</td>
            </tr>
            <tr>
              <td><span class="badge badge-p3">P3</span></td>
              <td>Add __experimental_liveEdit to singletons</td>
              <td><code>src/sanity/schemaTypes/singletons/*.ts</code></td>
              <td>5 min</td>
            </tr>
            <tr>
              <td><span class="badge badge-p3">P3</span></td>
              <td>Add .integer() validation to testimonial rating</td>
              <td><code>src/sanity/schemaTypes/testimonial.ts</code></td>
              <td>2 min</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2 id="findings-table">📊 All Findings Summary Table</h2>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Area</th>
              <th>Finding</th>
              <th>Severity</th>
              <th>Effort</th>
              <th>Impact</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Sanity Schema</td>
              <td>Missing slug uniqueness validation (5 types)</td>
              <td><span class="badge badge-p1">P1</span></td>
              <td><span class="badge badge-s">S</span></td>
              <td>Routing conflicts, SEO issues</td>
            </tr>
            <tr>
              <td>Sanity Schema</td>
              <td>No schema versioning system</td>
              <td><span class="badge badge-p1">P1</span></td>
              <td><span class="badge badge-m">M</span></td>
              <td>Cannot migrate safely</td>
            </tr>
            <tr>
              <td>Sanity Schema</td>
              <td>Inconsistent SEO schema (2 versions)</td>
              <td><span class="badge badge-p1">P1</span></td>
              <td><span class="badge badge-m">M</span></td>
              <td>Confusion, tech debt</td>
            </tr>
            <tr>
              <td>Sanity GROQ</td>
              <td>Missing pagination on list queries</td>
              <td><span class="badge badge-p1">P1</span></td>
              <td><span class="badge badge-s">S</span></td>
              <td>Query timeouts at scale</td>
            </tr>
            <tr>
              <td>Sanity Multi-Tenant</td>
              <td>Dataset validation function missing</td>
              <td><span class="badge badge-p1">P1</span></td>
              <td><span class="badge badge-s">S</span></td>
              <td>Silent data corruption</td>
            </tr>
            <tr>
              <td>Next.js Architecture</td>
              <td>Missing viewport metadata</td>
              <td><span class="badge badge-p1">P1</span></td>
              <td><span class="badge badge-s">S</span></td>
              <td>Mobile UX, SEO penalties</td>
            </tr>
            <tr>
              <td>Data Fetching</td>
              <td>Cache collision in multi-tenant</td>
              <td><span class="badge badge-p1">P1</span></td>
              <td><span class="badge badge-m">M</span></td>
              <td>Cross-site data leaks</td>
            </tr>
            <tr>
              <td>Data Fetching</td>
              <td>No error boundaries on SectionRenderer</td>
              <td><span class="badge badge-p1">P1</span></td>
              <td><span class="badge badge-m">M</span></td>
              <td>Full page crashes</td>
            </tr>
            <tr>
              <td>Accessibility</td>
              <td>Portable images not using Next/Image</td>
              <td><span class="badge badge-p1">P1</span></td>
              <td><span class="badge badge-m">M</span></td>
              <td>LCP, CLS, accessibility</td>
            </tr>
            <tr>
              <td>Performance</td>
              <td>Hero images missing priority hint</td>
              <td><span class="badge badge-p1">P1</span></td>
              <td><span class="badge badge-s">S</span></td>
              <td>Poor LCP, Core Web Vitals</td>
            </tr>
            <tr>
              <td>Security</td>
              <td>No CSP headers</td>
              <td><span class="badge badge-p1">P1</span></td>
              <td><span class="badge badge-m">M</span></td>
              <td>XSS vulnerability</td>
            </tr>
            <tr>
              <td>Security</td>
              <td>Unsanitized tracking scripts</td>
              <td><span class="badge badge-p1">P1</span></td>
              <td><span class="badge badge-m">M</span></td>
              <td>XSS via CMS</td>
            </tr>
            <tr>
              <td>Testing</td>
              <td>No accessibility tests</td>
              <td><span class="badge badge-p1">P1</span></td>
              <td><span class="badge badge-m">M</span></td>
              <td>WCAG compliance risk</td>
            </tr>
            <tr>
              <td colspan="5" style="text-align: center; background: var(--surface); font-weight: 600;">
                + 29 P2 findings, 18 P3 findings (see detailed sections above)
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2 id="pr-plan">🔄 Proposed PR Plan (5 PRs, smallest first)</h2>

      <div class="pr-plan">
        <h4>PR #1: Quick Wins & Validation Fixes (< 300 lines)</h4>
        <p><strong>Effort</strong>: 4 hours | <strong>Risk</strong>: Low | <strong>Impact</strong>: High</p>
        <ul>
          <li>✅ Add slug uniqueness validation to all 5 document types</li>
          <li>✅ Add viewport metadata to root layout</li>
          <li>✅ Add priority hint to hero images (first section only)</li>
          <li>✅ Add pagination limits to GROQ queries (servicesQ, locationsListQ)</li>
          <li>✅ Add defined() filters to reference arrays</li>
          <li>✅ Fix webhook exponential backoff calculation</li>
          <li>✅ Add aria-live regions to form feedback</li>
          <li>✅ Add font display: swap</li>
          <li>✅ Fix honeypot accessibility</li>
          <li>✅ Add __experimental_liveEdit to singletons</li>
        </ul>
        <p><strong>Files Changed</strong>: ~15 files</p>
        <p><strong>Testing</strong>: Manual testing in Studio (slug validation), Lighthouse (viewport, fonts), form testing (a11y)</p>
      </div>

      <div class="pr-plan">
        <h4>PR #2: Security Hardening (< 200 lines)</h4>
        <p><strong>Effort</strong>: 6 hours | <strong>Risk</strong>: Medium | <strong>Impact</strong>: Critical</p>
        <ul>
          <li>🔒 Add CSP headers in next.config.ts</li>
          <li>🔒 Add dataset-specific cache tags (prevent collision)</li>
          <li>🔒 Sanitize tracking scripts from CMS with DOMPurify</li>
          <li>🔒 Audit environment variable usage (no tokens client-side)</li>
          <li>🔒 Add iframe sandbox attributes to embedded HTML</li>
        </ul>
        <p><strong>Files Changed</strong>: ~5 files</p>
        <p><strong>Testing</strong>: Security headers validation, cache tag isolation testing, CSP report-only mode first</p>
      </div>

      <div class="pr-plan">
        <h4>PR #3: Accessibility & Performance (< 250 lines)</h4>
        <p><strong>Effort</strong>: 8 hours | <strong>Risk</strong>: Medium | <strong>Impact</strong>: High</p>
        <ul>
          <li>♿ Convert Portable images to Next.js Image component</li>
          <li>♿ Add aria-expanded to mega menu buttons</li>
          <li>♿ Add error boundaries around SectionRenderer</li>
          <li>⚡ Change analytics scripts to lazyOnload strategy</li>
          <li>⚡ Add route-specific error.tsx files</li>
          <li>⚡ Remove unnecessary 'use client' from Portable.tsx</li>
        </ul>
        <p><strong>Files Changed</strong>: ~8 files</p>
        <p><strong>Testing</strong>: Axe DevTools, Lighthouse, manual keyboard navigation, error boundary testing</p>
      </div>

      <div class="pr-plan">
        <h4>PR #4: Schema Consolidation & Versioning (< 300 lines)</h4>
        <p><strong>Effort</strong>: 1-2 days | <strong>Risk</strong>: Medium-High | <strong>Impact</strong>: High</p>
        <ul>
          <li>📋 Consolidate SEO schemas (objects/seo.ts → fields/seo.ts)</li>
          <li>📋 Add _schemaVersion field to all documents</li>
          <li>📋 Create migration script to backfill schema versions</li>
          <li>📋 Add alt text validation to all image fields</li>
          <li>📋 Add OG image dimension validation</li>
          <li>📋 Update deploy-schema-all to handle migrations</li>
        </ul>
        <p><strong>Files Changed</strong>: ~20 files</p>
        <p><strong>Testing</strong>: Test on staging dataset first, run migration dry-run, verify no data loss</p>
      </div>

      <div class="pr-plan">
        <h4>PR #5: Testing Infrastructure & Rate Limiting (< 300 lines)</h4>
        <p><strong>Effort</strong>: 2 days | <strong>Risk</strong>: Low | <strong>Impact</strong>: Medium</p>
        <ul>
          <li>🧪 Add Playwright accessibility tests (axe-core)</li>
          <li>🧪 Configure Lighthouse CI with budgets</li>
          <li>🧪 Add visual regression test suite</li>
          <li>🧪 Add type-check to pre-commit hooks</li>
          <li>🔐 Implement IP-based rate limiting (Upstash Redis)</li>
          <li>📊 Add bundle size budgets</li>
        </ul>
        <p><strong>Files Changed</strong>: ~12 files (mostly new test files)</p>
        <p><strong>Testing</strong>: Run full test suite, verify CI pipeline, test rate limiting with curl</p>
      </div>

      <h2 id="next-steps">✅ Next Steps Checklist</h2>

      <ul class="checklist">
        <li><strong>Immediate (Today)</strong>: Execute all Quick Wins (~2 hours total)</li>
        <li><strong>This Week</strong>: Complete PR #1 (Quick Wins & Validation) and PR #2 (Security Hardening)</li>
        <li><strong>Next Week</strong>: Complete PR #3 (Accessibility & Performance)</li>
        <li><strong>Week 3</strong>: Complete PR #4 (Schema Consolidation) - test thoroughly on staging first</li>
        <li><strong>Week 4</strong>: Complete PR #5 (Testing Infrastructure)</li>
        <li><strong>Before Production Deploy</strong>:
          <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
            <li>Run full Lighthouse CI on all key pages</li>
            <li>Run axe accessibility tests</li>
            <li>Validate CSP headers don't break third-party integrations</li>
            <li>Test cache isolation between datasets</li>
            <li>Verify rate limiting doesn't affect legitimate users</li>
          </ul>
        </li>
        <li><strong>Post-Deploy Monitoring</strong>:
          <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
            <li>Monitor Core Web Vitals in production</li>
            <li>Track form submission success rates</li>
            <li>Monitor Sanity API usage for query optimization impact</li>
            <li>Review CSP violation reports</li>
          </ul>
        </li>
      </ul>

      <div class="alert" style="margin-top: 2rem;">
        <strong>📌 Priority Recommendation</strong>: Focus on PR #1 and PR #2 first. These address the most critical security vulnerabilities (CSP, cache collision, XSS) and performance issues (LCP, query timeouts) affecting all 100+ sites. Total effort: ~10 hours, massive risk reduction.
      </div>

      <hr style="margin: 3rem 0; border: none; border-top: 1px solid var(--border);">

      <p style="text-align: center; color: var(--text-muted); font-size: 0.875rem;">
        <strong>Audit Report Generated</strong>: 2025-01-23<br>
        <strong>Platform</strong>: Local Business CMS (Next.js 15 + Sanity)<br>
        <strong>Audited By</strong>: sanity-cms-master-doctrine + frontend-developer-pro agents
      </p>
    </main>
  </div>

  <script>
    function copyCode(button) {
      const codeBlock = button.closest('.code-block').querySelector('pre');
      const code = codeBlock.textContent;

      navigator.clipboard.writeText(code).then(() => {
        button.textContent = 'Copied!';
        button.classList.add('copied');
        setTimeout(() => {
          button.textContent = 'Copy';
          button.classList.remove('copied');
        }, 2000);
      });
    }

    function toggleCollapsible(button) {
      button.classList.toggle('active');
      const content = button.nextElementSibling;
      content.classList.toggle('active');
    }

    // Smooth scroll for navigation
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });
  </script>
</body>
</html>